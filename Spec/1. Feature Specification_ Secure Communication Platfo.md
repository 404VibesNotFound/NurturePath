<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Feature Specification: Secure Communication Platform

## User Story

**As a** Patient (expecting mother), **I want to** send secure messages to my assigned midwife and receive timely responses, **so that** I can get immediate answers to my health concerns and feel supported throughout my pregnancy journey.

**As a** Provider (midwife), **I want to** communicate securely with my patients through a centralized messaging system with priority tagging, **so that** I can efficiently manage patient communications and respond to urgent matters promptly.

**As a** Family Member, **I want to** view non-sensitive communications between my partner and the midwife (with consent), **so that** I can stay informed and provide better support during the pregnancy.

## Feature Description

The Secure Communication Platform enables HIPAA-compliant messaging between patients, providers, and authorized family members. The system supports real-time messaging with read receipts, priority tagging for urgent communications, message threading for organized conversations, and role-based message visibility. The platform includes automated message classification, secure file attachments for medical documents, and integration with provider notification systems to ensure timely responses to patient inquiries.

Key capabilities include:

- End-to-end encrypted messaging with audit trails
- Priority classification system (Low, Normal, High, Urgent)
- Message threading and conversation history
- Secure file attachment support (images, documents, test results)
- Read receipt tracking and response time monitoring
- Role-based access control with consent management
- Mobile push notifications and email alerts
- Message search and filtering capabilities
- Automated escalation for urgent unread messages


## Acceptance Criteria

### Given-When-Then Format:

**Scenario 1: Patient sends message to provider**

- **Given** a patient is logged into the app and has an assigned midwife
- **When** they compose and send a message with priority level "High"
- **Then** the message is encrypted and stored in the database
- **And** the midwife receives a push notification within 30 seconds
- **And** the message appears in the provider's inbox with appropriate priority indicator

**Scenario 2: Provider responds to patient message**

- **Given** a midwife has received a patient message
- **When** they respond to the message
- **Then** the patient receives a notification
- **And** the message thread is updated with read receipts
- **And** the response time is logged for quality metrics

**Scenario 3: Family member access with consent**

- **Given** a family member is registered and linked to a patient account
- **When** the patient grants permission for communication visibility
- **Then** the family member can view non-sensitive message threads
- **And** sensitive medical information remains hidden based on provider classification


### Bullet Point Criteria:

- Messages must be encrypted both in transit and at rest
- System must support message priorities: Low, Normal, High, Urgent
- Urgent messages must trigger immediate notifications to providers
- File attachments must be scanned for malware and size-limited to 10MB
- Message history must be searchable and filterable by date, priority, and sender
- Read receipts must be tracked for all message types
- System must log all message activities for audit compliance
- Offline message queuing when network is unavailable
- Maximum message response time alerts for providers (configurable)
- Auto-archive messages older than 2 years (configurable)


## Complete Specification for Coding Agent

### Implementation Requirements

**Technology Stack:**

- Frontend: ReactJS with TypeScript
- Backend: .NET Core 8.0 Web API
- Database: PostgreSQL with Entity Framework Core
- Real-time Communication: SignalR
- Authentication: JWT with role-based authorization
- Encryption: AES-256 for data at rest, TLS 1.3 for data in transit


### Database Schema (JSON Format)

```json
{
  "User": {
    "Id": "integer (Primary Key)",
    "Email": "string (unique, not null)",
    "PasswordHash": "string (not null)",
    "FirstName": "string (not null)",
    "LastName": "string (not null)",
    "Role": "string (Patient/Provider/Family)",
    "IsActive": "boolean (default: true)",
    "CreatedAt": "datetime (not null)",
    "UpdatedAt": "datetime (not null)",
    "SentMessages": [
      { "$ref": "Message" }
    ],
    "ReceivedMessages": [
      { "$ref": "Message" }
    ],
    "PatientProviderRelationships": [
      { "$ref": "PatientProviderRelationship" }
    ],
    "FamilyAccess": [
      { "$ref": "FamilyAccess" }
    ]
  },
  "Message": {
    "Id": "integer (Primary Key)",
    "SenderId": "integer (FK -> User.Id)",
    "ReceiverId": "integer (FK -> User.Id)",
    "Subject": "string (max 200 chars)",
    "Content": "string (encrypted, not null)",
    "Priority": "string (Low/Normal/High/Urgent)",
    "MessageType": "string (Text/File/System)",
    "IsRead": "boolean (default: false)",
    "ReadAt": "datetime (nullable)",
    "IsArchived": "boolean (default: false)",
    "ThreadId": "string (nullable, for message grouping)",
    "ReplyToMessageId": "integer (nullable, FK -> Message.Id)",
    "CreatedAt": "datetime (not null)",
    "UpdatedAt": "datetime (not null)",
    "Sender": { "$ref": "User" },
    "Receiver": { "$ref": "User" },
    "ReplyToMessage": { "$ref": "Message" },
    "Replies": [
      { "$ref": "Message" }
    ],
    "MessageAttachments": [
      { "$ref": "MessageAttachment" }
    ]
  },
  "MessageAttachment": {
    "Id": "integer (Primary Key)",
    "MessageId": "integer (FK -> Message.Id)",
    "FileName": "string (not null)",
    "FileSize": "long (not null)",
    "ContentType": "string (not null)",
    "FilePath": "string (encrypted, not null)",
    "UploadedAt": "datetime (not null)",
    "Message": { "$ref": "Message" }
  },
  "PatientProviderRelationship": {
    "Id": "integer (Primary Key)",
    "PatientId": "integer (FK -> User.Id)",
    "ProviderId": "integer (FK -> User.Id)",
    "RelationshipType": "string (Primary/Secondary/Consultant)",
    "IsActive": "boolean (default: true)",
    "StartDate": "datetime (not null)",
    "EndDate": "datetime (nullable)",
    "CreatedAt": "datetime (not null)",
    "Patient": { "$ref": "User" },
    "Provider": { "$ref": "User" }
  },
  "FamilyAccess": {
    "Id": "integer (Primary Key)",
    "PatientId": "integer (FK -> User.Id)",
    "FamilyMemberId": "integer (FK -> User.Id)",
    "AccessLevel": "string (Basic/Extended)",
    "CanViewMessages": "boolean (default: false)",
    "CanViewAppointments": "boolean (default: true)",
    "ConsentGivenAt": "datetime (not null)",
    "ConsentExpiresAt": "datetime (nullable)",
    "IsActive": "boolean (default: true)",
    "CreatedAt": "datetime (not null)",
    "Patient": { "$ref": "User" },
    "FamilyMember": { "$ref": "User" }
  },
  "MessageReadStatus": {
    "Id": "integer (Primary Key)",
    "MessageId": "integer (FK -> Message.Id)",
    "UserId": "integer (FK -> User.Id)",
    "ReadAt": "datetime (not null)",
    "Message": { "$ref": "Message" },
    "User": { "$ref": "User" }
  }
}
```


### .NET Core Model Classes

```csharp
// User.cs
public class User
{
    public int Id { get; set; }
    public string Email { get; set; } = string.Empty;
    public string PasswordHash { get; set; } = string.Empty;
    public string FirstName { get; set; } = string.Empty;
    public string LastName { get; set; } = string.Empty;
    public UserRole Role { get; set; }
    public bool IsActive { get; set; } = true;
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // Navigation properties
    public virtual ICollection<Message> SentMessages { get; set; } = new List<Message>();
    public virtual ICollection<Message> ReceivedMessages { get; set; } = new List<Message>();
    public virtual ICollection<PatientProviderRelationship> PatientRelationships { get; set; } = new List<PatientProviderRelationship>();
    public virtual ICollection<PatientProviderRelationship> ProviderRelationships { get; set; } = new List<PatientProviderRelationship>();
    public virtual ICollection<FamilyAccess> PatientFamilyAccess { get; set; } = new List<FamilyAccess>();
    public virtual ICollection<FamilyAccess> FamilyMemberAccess { get; set; } = new List<FamilyAccess>();
}

public enum UserRole
{
    Patient = 1,
    Provider = 2,
    Family = 3
}

// Message.cs
public class Message
{
    public int Id { get; set; }
    public int SenderId { get; set; }
    public int ReceiverId { get; set; }
    public string Subject { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty; // Will be encrypted
    public MessagePriority Priority { get; set; }
    public MessageType MessageType { get; set; }
    public bool IsRead { get; set; } = false;
    public DateTime? ReadAt { get; set; }
    public bool IsArchived { get; set; } = false;
    public string? ThreadId { get; set; }
    public int? ReplyToMessageId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // Navigation properties
    public virtual User Sender { get; set; } = null!;
    public virtual User Receiver { get; set; } = null!;
    public virtual Message? ReplyToMessage { get; set; }
    public virtual ICollection<Message> Replies { get; set; } = new List<Message>();
    public virtual ICollection<MessageAttachment> MessageAttachments { get; set; } = new List<MessageAttachment>();
    public virtual ICollection<MessageReadStatus> ReadStatuses { get; set; } = new List<MessageReadStatus>();
}

public enum MessagePriority
{
    Low = 1,
    Normal = 2,
    High = 3,
    Urgent = 4
}

public enum MessageType
{
    Text = 1,
    File = 2,
    System = 3
}
```


### Backend API Endpoints

**Required Endpoints:**

1. `POST /api/messages` - Send new message
2. `GET /api/messages/conversations` - Get user's conversations
3. `GET /api/messages/thread/{threadId}` - Get messages in thread
4. `PUT /api/messages/{id}/read` - Mark message as read
5. `POST /api/messages/{id}/attachments` - Upload file attachment
6. `GET /api/messages/search` - Search messages
7. `DELETE /api/messages/{id}` - Archive message
8. `GET /api/users/contacts` - Get user's authorized contacts

### Frontend Components

**Required React Components:**

1. `MessageList.tsx` - Display conversation list
2. `MessageThread.tsx` - Show individual conversation
3. `MessageComposer.tsx` - Create new messages
4. `FileUpload.tsx` - Handle file attachments
5. `PrioritySelector.tsx` - Set message priority
6. `ContactList.tsx` - Show available contacts
7. `MessageSearch.tsx` - Search functionality

### Data Transfer Objects (DTOs)

```csharp
public class SendMessageRequest
{
    public int ReceiverId { get; set; }
    public string Subject { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty;
    public MessagePriority Priority { get; set; }
    public string? ThreadId { get; set; }
    public int? ReplyToMessageId { get; set; }
}

public class MessageResponse
{
    public int Id { get; set; }
    public int SenderId { get; set; }
    public string SenderName { get; set; } = string.Empty;
    public int ReceiverId { get; set; }
    public string ReceiverName { get; set; } = string.Empty;
    public string Subject { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty;
    public MessagePriority Priority { get; set; }
    public bool IsRead { get; set; }
    public DateTime? ReadAt { get; set; }
    public string? ThreadId { get; set; }
    public DateTime CreatedAt { get; set; }
    public List<MessageAttachmentResponse> Attachments { get; set; } = new();
}
```


### Security \& Authorization

**Requirements:**

- JWT-based authentication with role claims
- Message content encryption using AES-256
- Role-based authorization middleware
- CORS configuration for frontend access
- Rate limiting to prevent spam
- Input validation and sanitization
- SQL injection prevention through EF Core parameterized queries

**Authorization Rules:**

- Patients can only message their assigned providers
- Providers can message their assigned patients
- Family members can only view messages if consent is granted
- System administrators cannot access message content (encrypted)


### Error Handling \& Validation

**Validation Rules:**

- Message content: Required, max 5000 characters
- Subject: Required, max 200 characters
- File attachments: Max 10MB, specific MIME types only
- Recipients must have active relationship
- Priority level must be valid enum value

**Error Scenarios:**

- Unauthorized access attempts
- Invalid recipient relationships
- Network failures during message sending
- File upload failures
- Encryption/decryption errors
- Database connection issues


### Performance Requirements

- Message delivery within 30 seconds
- Real-time notifications via SignalR
- Support for 1000+ concurrent users
- Message search results within 2 seconds
- File upload progress indicators
- Offline message queuing


### Testing Requirements

**Unit Tests (80%+ Coverage):**

- Message service business logic
- Encryption/decryption functionality
- Authorization middleware
- Validation rules
- Repository patterns
- SignalR hub methods

**Integration Tests:**

- API endpoint functionality
- Database operations
- File upload workflows
- Real-time notification delivery


### Assumptions \& Constraints

**Assumptions:**

- Users have stable internet connection for real-time features
- Mobile devices support push notifications
- Healthcare providers are trained on digital communication protocols
- Patient consent for family access is obtained through separate process

**Constraints:**

- HIPAA compliance requirements for all communications
- 4-hour development window for MVP
- PostgreSQL database limitations
- Mobile app memory constraints for message history
- Network bandwidth considerations for file attachments


### Expected Input/Output Data Structures

**Input Example:**

```json
{
  "receiverId": 123,
  "subject": "Pregnancy concern - urgent",
  "content": "I'm experiencing unusual symptoms...",
  "priority": "High",
  "threadId": "thread_456",
  "replyToMessageId": 789
}
```

**Output Example:**

```json
{
  "id": 1001,
  "senderId": 456,
  "senderName": "Sarah Johnson",
  "receiverId": 123,
  "receiverName": "Dr. Emily Smith",
  "subject": "Pregnancy concern - urgent",
  "content": "I'm experiencing unusual symptoms...",
  "priority": "High",
  "isRead": false,
  "readAt": null,
  "threadId": "thread_456",
  "createdAt": "2025-09-01T10:01:00Z",
  "attachments": []
}
```


### Coding Agent Prompt

```markdown
# Secure Communication Platform Implementation

## Objective
Implement a complete secure messaging system for a maternal health application connecting midwives with expecting families. Build production-quality code with comprehensive testing.

## Technical Requirements

### Backend (.NET Core 8.0)
1. **Create Entity Framework models** based on the provided database schema
2. **Implement repository pattern** for data access with interfaces
3. **Create message service** with encryption/decryption capabilities using AES-256
4. **Build Web API controllers** with proper authorization attributes
5. **Add SignalR hub** for real-time messaging notifications
6. **Implement JWT authentication** with role-based claims
7. **Create input validation** using FluentValidation
8. **Add exception handling middleware** with proper error responses
9. **Implement file upload service** with virus scanning and size validation
10. **Add comprehensive logging** using ILogger interface

### Frontend (ReactJS + TypeScript)
1. **Create message components** with responsive design
2. **Implement real-time updates** using SignalR connection
3. **Add file upload functionality** with progress indicators
4. **Create message search and filtering** capabilities
5. **Implement proper error handling** with user-friendly messages
6. **Add loading states** and optimistic UI updates
7. **Create responsive layout** for mobile and desktop
8. **Implement accessibility features** (ARIA labels, keyboard navigation)

### Database Migration
1. **Create EF Core migration** for all message-related tables
2. **Add proper indexes** for performance optimization
3. **Include data seeding** for development/testing
4. **Add foreign key constraints** and cascade rules

### Security Implementation
1. **Encrypt sensitive data** before database storage
2. **Implement rate limiting** to prevent abuse
3. **Add CORS policy** for frontend access
4. **Validate all inputs** and sanitize user content
5. **Implement audit logging** for compliance
6. **Add role-based authorization** at controller and method level

### Testing Requirements
1. **Unit tests** for all service methods (minimum 80% coverage)
2. **Integration tests** for API endpoints
3. **Mock external dependencies** (file storage, notification services)
4. **Test error scenarios** and edge cases
5. **Performance tests** for concurrent message handling
6. **Security tests** for authorization and encryption

### Documentation Requirements
1. **XML documentation** for all public methods
2. **Inline comments** explaining complex business logic
3. **API documentation** with request/response examples
4. **Database schema documentation** with relationship explanations
5. **README file** with setup and deployment instructions

## Business Logic Requirements

### Message Flow
1. User composes message with priority selection
2. System validates recipient relationship and permissions
3. Content is encrypted before database storage
4. Real-time notification sent to recipient
5. Message appears in recipient's inbox with priority indicator
6. Read receipts tracked when message is opened
7. Response creates threaded conversation

### Priority Handling
- **Urgent**: Immediate push notification + SMS backup
- **High**: Push notification within 1 minute
- **Normal**: Standard notification
- **Low**: Batched daily digest

### Family Access Control
- Family members require explicit patient consent
- Sensitive medical information filtered based on provider settings
- Consent can be revoked at any time
- Audit trail maintained for all access grants/revocations

## Error Handling Requirements
1. **Network failures**: Queue messages for retry
2. **Invalid recipients**: Clear error with suggested contacts
3. **File upload errors**: Specific error messages and retry options
4. **Encryption failures**: Fallback mechanism and error logging
5. **Database errors**: Graceful degradation with user notification

## Performance Targets
- Message send/receive: <500ms
- File upload: Progress indicator, max 10MB
- Search results: <2 seconds
- Real-time notifications: <30 seconds
- Concurrent users: Support 1000+ active connections

Build this feature as a complete, production-ready implementation that can be deployed immediately after development. Include comprehensive error handling, security measures, and thorough testing to ensure reliability in a healthcare environment.
```

This specification provides complete guidance for implementing the secure communication platform with all necessary technical details, security requirements, and testing specifications needed for a production-quality healthcare application.

